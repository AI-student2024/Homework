# RBACæƒé™æ§åˆ¶ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“– é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºFastAPIå®ç°çš„RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰æƒé™æ§åˆ¶ç³»ç»Ÿã€‚RBACæ˜¯ä¸€ç§è®¿é—®æ§åˆ¶æ¨¡å‹ï¼Œé€šè¿‡è§’è‰²æ¥ç®¡ç†ç”¨æˆ·æƒé™ï¼Œä½¿å¾—æƒé™ç®¡ç†æ›´åŠ çµæ´»å’Œå¯ç»´æŠ¤ã€‚

### ğŸ¯ ç³»ç»Ÿç‰¹ç‚¹

- **ç”¨æˆ·è®¤è¯**ï¼šåŸºäºOAuth2 Bearer Tokençš„è®¤è¯æœºåˆ¶
- **è§’è‰²ç®¡ç†**ï¼šæ”¯æŒå¤šè§’è‰²åˆ†é…å’Œæƒé™ç»§æ‰¿
- **æƒé™æ§åˆ¶**ï¼šè£…é¥°å™¨é©±åŠ¨çš„APIç«¯ç‚¹æƒé™ä¿æŠ¤
- **çµæ´»é…ç½®**ï¼šæ˜“äºæ‰©å±•å’Œè‡ªå®šä¹‰çš„æƒé™ç³»ç»Ÿ
- **å®Œæ•´æµ‹è¯•**ï¼šåŒ…å«è‡ªåŠ¨åŒ–æµ‹è¯•å’Œäº¤äº’å¼CLIæµ‹è¯•

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
RBACç³»ç»Ÿ
â”œâ”€â”€ æ•°æ®æ¨¡å‹ (User, Role)
â”œâ”€â”€ è®¤è¯ä¾èµ– (OAuth2PasswordBearer)
â”œâ”€â”€ æƒé™è£…é¥°å™¨ (@permission_required)
â”œâ”€â”€ APIè·¯ç”± (FastAPI endpoints)
â”œâ”€â”€ æ¨¡æ‹Ÿæ•°æ®åº“ (fake_users_db, fake_roles_db)
â””â”€â”€ æµ‹è¯•å·¥å…· (è‡ªåŠ¨åŒ–æµ‹è¯• + äº¤äº’å¼CLI)
```

### æƒé™æ¨¡å‹

```
ç”¨æˆ· (User)
â”œâ”€â”€ ç”¨æˆ·å (username)
â”œâ”€â”€ å¯†ç  (password)
â”œâ”€â”€ è§’è‰²åˆ—è¡¨ (roles)
â””â”€â”€ çŠ¶æ€ (disabled)

è§’è‰² (Role)
â”œâ”€â”€ è§’è‰²å (name)
â””â”€â”€ æƒé™åˆ—è¡¨ (permissions)

æƒé™ (Permissions)
â”œâ”€â”€ create - åˆ›å»ºæƒé™
â”œâ”€â”€ read - è¯»å–æƒé™
â”œâ”€â”€ update - æ›´æ–°æƒé™
â””â”€â”€ delete - åˆ é™¤æƒé™
```

## ğŸ”§ å®‰è£…å’Œè¿è¡Œ

### ç¯å¢ƒè¦æ±‚

- Python 3.7+
- FastAPI
- Uvicorn

### å®‰è£…ä¾èµ–

```bash
pip install fastapi uvicorn
```

### è¿è¡Œæ–¹å¼

#### 1. å¯åŠ¨APIæœåŠ¡å™¨

```bash
uvicorn rbac_simple:app --reload
```

æœåŠ¡å™¨å°†åœ¨ `http://localhost:8000` å¯åŠ¨

#### 2. è¿è¡Œæµ‹è¯•å·¥å…·

```bash
python rbac_simple.py
```

é€‰æ‹©è¿è¡Œæ¨¡å¼ï¼š
- é€‰é¡¹1ï¼šè¿è¡Œå®Œæ•´è‡ªåŠ¨åŒ–æµ‹è¯•
- é€‰é¡¹2ï¼šå¯åŠ¨äº¤äº’å¼CLIæµ‹è¯•ç•Œé¢

## ğŸ“š APIæ–‡æ¡£

### è®¤è¯ç«¯ç‚¹

#### POST /token
ç”¨æˆ·ç™»å½•è·å–è®¿é—®ä»¤ç‰Œ

**è¯·æ±‚å‚æ•°ï¼š**
- `username`: ç”¨æˆ·å
- `password`: å¯†ç 

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "access_token": "admin",
  "token_type": "bearer"
}
```

### å—ä¿æŠ¤çš„ç«¯ç‚¹

#### GET /admin-only
ç®¡ç†å‘˜ä¸“ç”¨è·¯ç”±ï¼Œéœ€è¦ `delete` æƒé™

#### GET /editor-content
ç¼–è¾‘è€…å†…å®¹è·¯ç”±ï¼Œéœ€è¦ `update` æƒé™

#### GET /public-content
å…¬å¼€å†…å®¹è·¯ç”±ï¼Œéœ€è¦ `read` æƒé™

#### GET /me
è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œéœ€è¦ `read` æƒé™

## ğŸ” æƒé™æ§åˆ¶æœºåˆ¶

### æƒé™è£…é¥°å™¨

ä½¿ç”¨ `@permission_required(permission)` è£…é¥°å™¨æ¥ä¿æŠ¤APIç«¯ç‚¹ï¼š

```python
@app.get("/admin-only")
@permission_required("delete")
async def admin_only_route(current_user: User = Depends(get_current_user)):
    return {"message": "This is an admin-only route"}
```

### æƒé™éªŒè¯æµç¨‹

1. **ç”¨æˆ·è®¤è¯**ï¼šéªŒè¯Bearer Token
2. **è§’è‰²è·å–**ï¼šä»ç”¨æˆ·ä¿¡æ¯ä¸­æå–è§’è‰²åˆ—è¡¨
3. **æƒé™æ£€æŸ¥**ï¼šéå†è§’è‰²ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«æ‰€éœ€æƒé™
4. **è®¿é—®æ§åˆ¶**ï¼šæ ¹æ®æƒé™éªŒè¯ç»“æœå†³å®šæ˜¯å¦å…è®¸è®¿é—®

### é»˜è®¤ç”¨æˆ·å’Œè§’è‰²

#### ç”¨æˆ·åˆ—è¡¨
- `admin` / `adminpass` - ç®¡ç†å‘˜ç”¨æˆ·
- `editor` / `editorpass` - ç¼–è¾‘è€…ç”¨æˆ·  
- `viewer` / `viewerpass` - æŸ¥çœ‹è€…ç”¨æˆ·

#### è§’è‰²æƒé™
- **admin**: `create`, `read`, `update`, `delete`
- **editor**: `read`, `update`
- **viewer**: `read`

## ğŸ§ª æµ‹è¯•æŒ‡å—

### è‡ªåŠ¨åŒ–æµ‹è¯•

è¿è¡Œå®Œæ•´çš„è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶ï¼š

```bash
python rbac_simple.py
# é€‰æ‹©é€‰é¡¹ 1
```

æµ‹è¯•å†…å®¹åŒ…æ‹¬ï¼š
- ç”¨æˆ·è®¤è¯æµç¨‹
- è§’è‰²æƒé™çŸ©é˜µ
- APIç«¯ç‚¹è®¿é—®æƒé™
- æƒé™æ§åˆ¶è£…é¥°å™¨
- ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯

### äº¤äº’å¼CLIæµ‹è¯•

å¯åŠ¨äº¤äº’å¼æµ‹è¯•ç•Œé¢ï¼š

```bash
python rbac_simple.py
# é€‰æ‹©é€‰é¡¹ 2
```

#### æµ‹è¯•é€‰é¡¹

1. **ğŸ” ç”¨æˆ·ç™»å½•æµ‹è¯•**
   - æ‰‹åŠ¨è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
   - æŸ¥çœ‹è®¤è¯ç»“æœå’Œç”¨æˆ·æƒé™

2. **ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯æŸ¥çœ‹**
   - æŸ¥çœ‹æŒ‡å®šç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯
   - æ˜¾ç¤ºç”¨æˆ·è§’è‰²å’Œæƒé™

3. **ğŸ”‘ æƒé™éªŒè¯æµ‹è¯•**
   - æµ‹è¯•ç‰¹å®šç”¨æˆ·æ˜¯å¦æ‹¥æœ‰ç‰¹å®šæƒé™
   - è¯¦ç»†çš„æƒé™æ£€æŸ¥è¿‡ç¨‹

4. **ğŸŒ APIç«¯ç‚¹æƒé™æµ‹è¯•**
   - æµ‹è¯•ç”¨æˆ·å¯¹å„ä¸ªAPIç«¯ç‚¹çš„è®¿é—®æƒé™
   - æ¨¡æ‹ŸçœŸå®çš„APIè®¿é—®åœºæ™¯

5. **ğŸ“Š è§’è‰²æƒé™çŸ©é˜µ**
   - æ˜¾ç¤ºæ‰€æœ‰è§’è‰²çš„æƒé™åˆ†å¸ƒ
   - æƒé™ç»Ÿè®¡ä¿¡æ¯

6. **ğŸ§ª è‡ªå®šä¹‰æƒé™æµ‹è¯•**
   - æƒé™åŒ…å«å…³ç³»æ£€æŸ¥
   - ç”¨æˆ·æƒé™æ¯”è¾ƒ
   - è‡ªå®šä¹‰æƒé™éªŒè¯

7. **ğŸ“ˆ ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯**
   - ç”¨æˆ·ã€è§’è‰²ã€æƒé™æ€»æ•°
   - è¯¦ç»†çš„ç³»ç»Ÿæ¦‚è§ˆ

8. **ğŸš€ è¿è¡Œå®Œæ•´è‡ªåŠ¨åŒ–æµ‹è¯•**
   - æ‰§è¡Œæ‰€æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### 1. è·å–è®¿é—®ä»¤ç‰Œ

```bash
curl -X POST "http://localhost:8000/token" \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "username=admin&password=adminpass"
```

### 2. è®¿é—®å—ä¿æŠ¤çš„ç«¯ç‚¹

```bash
curl -X GET "http://localhost:8000/admin-only" \
     -H "Authorization: Bearer admin"
```

### 3. æµ‹è¯•ä¸åŒè§’è‰²çš„æƒé™

```bash
# ç®¡ç†å‘˜è®¿é—®ç¼–è¾‘è€…å†…å®¹
curl -X GET "http://localhost:8000/editor-content" \
     -H "Authorization: Bearer admin"

# ç¼–è¾‘è€…è®¿é—®ç®¡ç†å‘˜å†…å®¹ï¼ˆåº”è¯¥è¢«æ‹’ç»ï¼‰
curl -X GET "http://localhost:8000/admin-only" \
     -H "Authorization: Bearer editor"
```

## ğŸ”§ æ‰©å±•å’Œè‡ªå®šä¹‰

### æ·»åŠ æ–°ç”¨æˆ·

åœ¨ `fake_users_db` ä¸­æ·»åŠ æ–°ç”¨æˆ·ï¼š

```python
fake_users_db["newuser"] = User(
    username="newuser", 
    password="newpass", 
    roles=["editor"]
)
```

### æ·»åŠ æ–°è§’è‰²

åœ¨ `fake_roles_db` ä¸­æ·»åŠ æ–°è§’è‰²ï¼š

```python
fake_roles_db["moderator"] = Role(
    name="moderator", 
    permissions=["read", "update", "moderate"]
)
```

### æ·»åŠ æ–°æƒé™

åœ¨è§’è‰²å®šä¹‰ä¸­æ·»åŠ æ–°æƒé™ï¼š

```python
fake_roles_db["admin"].permissions.append("moderate")
```

### è‡ªå®šä¹‰æƒé™è£…é¥°å™¨

åˆ›å»ºæ›´å¤æ‚çš„æƒé™æ£€æŸ¥é€»è¾‘ï¼š

```python
def role_required(role_name: str):
    def decorator(func: Callable):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            current_user = kwargs.get("current_user")
            if role_name not in current_user.roles:
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail=f"Require {role_name} role"
                )
            return await func(*args, **kwargs)
        return wrapper
    return decorator
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

### å®‰å…¨è€ƒè™‘

1. **ç”Ÿäº§ç¯å¢ƒ**ï¼šå½“å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®åº“ï¼Œç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨çœŸå®çš„æ•°æ®åº“
2. **å¯†ç å®‰å…¨**ï¼šå®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨åŠ å¯†å­˜å‚¨å¯†ç 
3. **Tokenç®¡ç†**ï¼šå®ç°Tokenè¿‡æœŸå’Œåˆ·æ–°æœºåˆ¶
4. **æƒé™å®¡è®¡**ï¼šè®°å½•æƒé™è®¿é—®æ—¥å¿—

### æ€§èƒ½ä¼˜åŒ–

1. **æƒé™ç¼“å­˜**ï¼šç¼“å­˜ç”¨æˆ·æƒé™ä¿¡æ¯
2. **æ•°æ®åº“ç´¢å¼•**ï¼šä¸ºæƒé™æŸ¥è¯¢æ·»åŠ é€‚å½“çš„ç´¢å¼•
3. **æ‰¹é‡æƒé™æ£€æŸ¥**ï¼šä¼˜åŒ–å¤šæƒé™éªŒè¯çš„æ€§èƒ½

## ğŸ“– ç›¸å…³èµ„æº

- [FastAPIå®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [OAuth2è§„èŒƒ](https://oauth.net/2/)
- [RBACæ¨¡å‹ä»‹ç»](https://en.wikipedia.org/wiki/Role-based_access_control)
- [Pythonè£…é¥°å™¨æ•™ç¨‹](https://realpython.com/primer-on-python-decorators/)

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ï¼

### å¼€å‘ç¯å¢ƒè®¾ç½®

1. Forké¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. åˆ›å»ºPull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ï¼Œè¯¦è§LICENSEæ–‡ä»¶ã€‚

---

**ğŸ‰ æ„Ÿè°¢ä½¿ç”¨RBACæƒé™æ§åˆ¶ç³»ç»Ÿï¼**

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡Issueæˆ–Pull Requestè”ç³»æˆ‘ä»¬ã€‚
